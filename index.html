<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>لوحة النقاط القرآنية</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600&display=swap');
    :root {
      --primary: #2a5f5e;
      --primary-light: #87b6b5;
      --secondary: rgba(255, 255, 255, 0.9);
      --text: #2d3436;
      --shadow: rgba(0,0,0,0.1);
      --radius: 8px;
      --gap: 1rem;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Cairo', sans-serif;
      min-height: 100vh;
      background: 
        linear-gradient(45deg, rgba(42, 95, 94, 0.1), rgba(135, 182, 181, 0.1)),
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="100" height="100"><path fill="%232a5f5e" opacity="0.1" d="M50 0L100 50 50 100 0 50 50 0zM0 0l50 50L0 100zm100 0L50 50l50 50z"/></svg>');
      background-size: cover;
      color: var(--text);
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 24px,
        rgba(42, 95, 94, 0.05) 24px,
        rgba(42, 95, 94, 0.05) 25px
      );
      z-index: -1;
    }

    .app {
      display: flex;
      min-height: 100vh;
      backdrop-filter: blur(2px);
    }

    .sidebar {
      width: 260px;
      flex-shrink: 0;
      background: var(--secondary);
      box-shadow: 2px 0 8px var(--shadow);
      border-left: 1px solid rgba(42, 95, 94, 0.1);
    }

    .sidebar h2 {
      margin: 0;
      padding: var(--gap);
      background: var(--primary);
      color: #fff;
      text-align: center;
      font-weight: 600;
      font-size: 1.5rem;
      letter-spacing: 1px;
      border-bottom: 3px solid rgba(255, 255, 255, 0.2);
    }

    .student-list {
      list-style: none;
      margin: 0;
      padding: 0;
      overflow-y: auto;
    }

    .student-list li {
      padding: 1.5rem var(--gap);
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(135, 182, 181, 0.15);
      border-bottom: 1px solid rgba(42, 95, 94, 0.1);
      position: relative;
    }

    .student-list li:hover {
      background: rgba(42, 95, 94, 0.2);
      padding-right: 2rem;
    }

    .student-list li::before {
      content: '﴿';
      position: absolute;
      right: 0.5rem;
      color: var(--primary);
      opacity: 0.5;
      font-size: 1.2rem;
    }

    .student-list li.active {
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      box-shadow: inset 4px 0 0 rgba(255, 255, 255, 0.3);
    }

    .main {
      flex: 1;
      padding: var(--gap);
      background: linear-gradient(to left, rgba(255,255,255,0.8), rgba(255,255,255,0.4));
    }

    .form-section,
    .stats,
    .ranking-section {
      background: var(--secondary);
      border-radius: var(--radius);
      padding: var(--gap);
      box-shadow: 0 2px 12px rgba(42, 95, 94, 0.1);
      margin-bottom: var(--gap);
      border: 1px solid rgba(42, 95, 94, 0.1);
      backdrop-filter: blur(3px);
    }

    h3 {
      margin: 0 0 var(--gap);
      font-weight: 600;
      color: var(--primary);
      position: relative;
      padding-right: 1.5rem;
    }

    h3::after {
      content: '';
      position: absolute;
      right: 0;
      bottom: -0.5rem;
      width: 50px;
      height: 2px;
      background: var(--primary);
    }

    label {
      display: block;
      margin-top: 0.5rem;
      font-weight: 500;
    }

    select,
    input[type="number"] {
      width: 90%;
      padding: 0.5rem;
      margin-top: 0.3rem;
      border: 1px solid rgba(42, 95, 94, 0.3);
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.7);
      transition: all 0.3s ease;
    }

    select:focus,
    input[type="number"]:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 2px rgba(42, 95, 94, 0.2);
    }

    input[type="checkbox"] {
      transform: scale(1.2);
      margin-left: 0.5rem;
      accent-color: var(--primary);
    }

    .grid-4 {
      display: flex;
      flex-wrap: wrap;
      gap: var(--gap);
    }

    .form-section .grid-4:first-of-type {
      flex-direction: column;
    }

    .grid-4 > div {
      flex: 1;
      min-width: 200px;
      background: rgba(234, 255, 234, 0.3);
      padding: var(--gap);
      border-radius: var(--radius);
      border: 1px solid rgba(42, 95, 94, 0.1);
    }

    .container-group {
      margin-top: var(--gap);
      display: grid;
      gap: var(--gap);
      background: rgba(234, 255, 234, 0.3);
      padding: var(--gap);
      border-radius: var(--radius);
      border: 1px solid rgba(42, 95, 94, 0.1);
    }

    .container-group .row {
      background: rgba(255, 255, 255, 0.5);
      padding: var(--gap);
      border-radius: var(--radius);
      border: 1px solid rgba(42, 95, 94, 0.1);
    }

    .row {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .stat-item {
      background: rgba(255, 255, 255, 0.7);
      padding: 0.5rem;
      border-radius: var(--radius);
      margin: 0.5rem 0;
      box-shadow: 0 1px 4px var(--shadow);
      border-left: 3px solid var(--primary);
    }

    button {
      margin-top: var(--gap);
      padding: 0.7rem 1.5rem;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(42, 95, 94, 0.2);
    }

    button:hover {
      background: var(--primary-light);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(42, 95, 94, 0.3);
    }

    .result {
      font-size: 2rem;
      margin-top: var(--gap);
      font-weight: 700;
      text-align: center;
      color: var(--primary);
      text-shadow: 0 2px 3px rgba(42, 95, 94, 0.2);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 1px 10px rgba(42, 95, 94, 0.1);
    }

    th,
    td {
      padding: 0.5rem;
      border: 1px solid rgba(42, 95, 94, 0.2);
      text-align: center;
    }

    th {
      background: rgba(42, 95, 94, 0.7);
      color: white;
    }

    tr:nth-child(even) {
      background: rgba(42, 95, 94, 0.05);
    }

    tr:hover {
      background: rgba(42, 95, 94, 0.1);
    }
  </style>
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      const diff = {
        1: 2, 2: 0.8, 3: 1.5, 4: 1.5, 5: 1.5, 6: 1.5, 7: 0.8,
        8: 0.8, 9: 1.5, 10: 1.5, 11: 0.8, 12: 1.5, 13: 1.5,
        14: 0.6, 15: 2, 16: 2, 17: 0.8, 18: 0.8, 19: 1.5,
        20: 1.5, 21: 1.5, 22: 1.5, 23: 0.8, 24: 1.5, 25: 0.6,
        26: 0.8, 27: 0.8, 28: 0.6, 29: 1.5, 30: 2.2
      };

      const students = [
        "فضل بواعنة",
        "أوس مصطفى",
        "المتيم بالله أحمد",
        "يوسف عبد القادر",
        "المعتصم بالله أحمد",
        "علاء الرياحنة",
        "بهاء الدين عمار"
      ];

      const MAX_PARTS = 30;
      const studentData = {};
      let current = null;

      const timeSel = document.getElementById('time');
      const ul = document.getElementById('studentList');

      function fillSelect(el, from, to) {
        for (let i = from; i <= to; i++) {
          let o = document.createElement('option');
          o.value = i;
          o.textContent = i;
          el.appendChild(o);
        }
      }

      ['numFull', 'numSub', 'numNew', 'numHW'].forEach(id => 
        fillSelect(document.getElementById(id), 0, MAX_PARTS));

      fillSelect(document.getElementById('adab'), 0, 20);
      fillSelect(document.getElementById('focus'), 1, 3);

      for (let h = 5; h <= 8; h++) {
        [0, 15, 30, 45].forEach(m => {
          if (h === 8 && m > 30) return;
          let v = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
          let o = document.createElement('option');
          o.value = v;
          o.textContent = v;
          timeSel.appendChild(o);
        });
      }

      function createRow(cnt, type) {
        let row = document.createElement('div');
        row.className = 'row';
        if (['sub', 'new', 'hw'].includes(type)) {
          let ip = document.createElement('input');
          ip.type = 'number';
          ip.placeholder = 'صفحات';
          ip.min = 0;
          row.appendChild(ip);
        }
        let sel = document.createElement('select');
        for (let p = 1; p <= MAX_PARTS; p++) {
          let o = document.createElement('option');
          o.value = p;
          o.textContent = p;
          sel.appendChild(o);
        }
        row.appendChild(sel);
        ['أخطاء', 'تكرار'].forEach(ph => {
          let inp = document.createElement('input');
          inp.type = 'number';
          inp.placeholder = ph;
          inp.min = 0;
          row.appendChild(inp);
        });
        cnt.appendChild(row);
      }

      ['numFull', 'numSub', 'numNew', 'numHW'].forEach((id, i) => {
        document.getElementById(id).addEventListener('change', e => {
          let ids = ['fullContainer', 'subContainer', 'newContainer', 'hwContainer'];
          let cnt = document.getElementById(ids[i]);
          cnt.innerHTML = '';
          for (let k = 0; k < +e.target.value; k++) {
            createRow(cnt, ids[i].replace('Container', ''));
          }
        });
      });

      students.forEach(name => {
        studentData[name] = {};
        let li = document.createElement('li');
        li.textContent = name;
        li.addEventListener('click', () => selectStudent(name, li));
        ul.appendChild(li);
      });

      function selectStudent(name, li) {
        current = name;
        document.querySelectorAll('.student-list li').forEach(x => 
          x.classList.remove('active'));
        li.classList.add('active');
        document.getElementById('currentName').textContent = name;
        let d = studentData[name];
        ['numFull', 'numSub', 'numNew', 'numHW', 'adab', 'time', 'focus'].forEach(id => {
          if (d[id] != null) document.getElementById(id).value = d[id];
        });
        document.getElementById('mushaf').checked = d.mushaf || false;
        ['numFull', 'numSub', 'numNew', 'numHW'].forEach(id => 
          document.getElementById(id).dispatchEvent(new Event('change')));
        document.getElementById('statsSection').style.display = 'none';
        document.getElementById('rankingSection').style.display = 'none';
      }

      function renderStats(d) {
        const stats = document.getElementById('statsList');
        stats.innerHTML = '';
        const greenBox = (title, content) => 
          `<div class="stat-item"><strong>${title}</strong><br>${content}</div>`;

        stats.innerHTML += greenBox('نقاط الأدب', d.adab);
        stats.innerHTML += greenBox('التأخير', `${d.late} دقيقة (خصم: ${d.delay.toFixed(2)})`);
        stats.innerHTML += greenBox('نقاط الحفظ بعد الخصم', d.hifdh.toFixed(2));

        const types = [
          { key: 'fullContainer', label: 'الأجزاء الكاملة' },
          { key: 'subContainer', label: 'الأجزاء الجزئية' },
          { key: 'newContainer', label: 'التسميع الجديد' },
          { key: 'hwContainer', label: 'واجب الحفظ' }
        ];

        types.forEach(t => {
          let content = '';
          d[t.key].forEach(item => {
            const part = item.part;
            const penalty = d.penDetails.find(p => p.part === part)?.penalty || 0;
            content += `الجزء ${part}: خصم ${penalty.toFixed(2)}<br>`;
          });
          if (content) stats.innerHTML += greenBox(t.label, content);
        });

        stats.innerHTML += greenBox('التركيز', d.focus);
        stats.innerHTML += greenBox('أحضر المصحف', d.mushaf ? 'نعم' : 'لا');
        document.getElementById('statsSection').style.display = 'block';
      }

      document.getElementById('calculate').addEventListener('click', () => {
        if (!current) return alert('اختر طالبًا أولًا');
        
        let d = {
          mushaf: document.getElementById('mushaf').checked,
          adab: +document.getElementById('adab').value,
          focus: +document.getElementById('focus').value,
          time: document.getElementById('time').value
        };

        ['fullContainer', 'subContainer', 'newContainer', 'hwContainer'].forEach(cid => {
          d[cid] = [];
          document.querySelectorAll(`#${cid} .row`).forEach(r => {
            let inp = r.querySelectorAll('input, select');
            let idx = 0;
            let it = {};
            if (inp.length > 3) it.pages = +inp[idx++].value;
            it.part = +inp[idx++].value;
            it.errors = +inp[idx++].value;
            it.reps = +inp[idx++].value;
            d[cid].push(it);
          });
        });

        d.penDetails = [];
        const [sh, sm] = [5, 30];
        const [h, m] = d.time.split(':').map(Number);
        d.late = Math.max(0, h * 60 + m - (sh * 60 + sm));
        d.delay = d.late >= 180 ? 0 : (1 - d.late / 180) * 10;

        ['fullContainer', 'subContainer', 'newContainer', 'hwContainer'].forEach(cid => {
          d[cid].forEach(item => {
            const part = item.part;
            const pd = (item.errors * (diff[part] || 0) * 2 + item.reps * (diff[part] || 0) * 0.5) / (d[cid].length || 1);
            d.penDetails.push({ part, penalty: pd });
          });
        });

        d.hifdh = Math.max(0, 60 - d.penDetails.reduce((s, p) => s + p.penalty, 0));
        d.total = +(((d.adab + d.delay + d.hifdh + d.focus + (d.mushaf ? 2 : 0)) / 95 * 100).toFixed(2));
        studentData[current] = d;
        document.getElementById('result').textContent = d.total + ' %';
        renderStats(d);
      });

      document.getElementById('showRanking').addEventListener('click', () => {
        const arr = Object.entries(studentData)
          .filter(([, v]) => v.total != null)
          .map(([n, v]) => ({ name: n, total: v.total }));
        
        arr.sort((a, b) => b.total - a.total);
        const tbody = document.getElementById('rankingBody');
        tbody.innerHTML = '';
        
        arr.forEach((s, i) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${s.name}</td>
            <td>${s.total.toFixed(2)}</td>
          `;
          tbody.appendChild(tr);
        });
        document.getElementById('rankingSection').style.display = 'block';
      });

      document.getElementById('exportExcel').addEventListener('click', () => {
        const students = Object.entries(studentData)
          .filter(([_, data]) => data.total)
          .map(([name, data]) => ({
            الاسم: name,
            'نقاط الأدب': data.adab,
            'التأخير (دقائق)': data.late,
            'خصم التأخير': data.delay.toFixed(2),
            'نقاط الحفظ بعد الخصم': data.hifdh.toFixed(2),
            'التركيز': data.focus,
            'أحضر المصحف': data.mushaf ? 'نعم' : 'لا',
            'إجمالي النسبة': data.total.toFixed(2),
            'تفاصيل الخصومات': data.penDetails.map(p => `جزء ${p.part}: ${p.penalty.toFixed(2)}`).join('، ')
          }));

        const ws = XLSX.utils.json_to_sheet(students);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "الطلاب");
        XLSX.writeFile(wb, "إحصائيات_الطلاب.xlsx");
      });
    });
  </script>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <h2>الطلاب</h2>
      <ul class="student-list" id="studentList"></ul>
    </aside>
    <main class="main">
      <section class="form-section">
        <h3 id="currentName">اختر طالبًا</h3>
        <div class="grid-4">
          <div>
            <label>الأجزاء الكاملة:</label>
            <select id="numFull"></select>
            <div class="container-group" id="fullContainer"></div>
          </div>
          <div>
            <label>الأجزاء الجزئية:</label>
            <select id="numSub"></select>
            <div class="container-group" id="subContainer"></div>
          </div>
          <div>
            <label>التسميع الجديد:</label>
            <select id="numNew"></select>
            <div class="container-group" id="newContainer"></div>
          </div>
          <div>
            <label>واجب الحفظ:</label>
            <select id="numHW"></select>
            <div class="container-group" id="hwContainer"></div>
          </div>
        </div>
        <div class="grid-4">
          <div>
            <label>نقاط الأدب:</label>
            <select id="adab"></select>
          </div>
          <div>
            <label>ساعة الحضور:</label>
            <select id="time"></select>
          </div>
          <div>
            <label>أحضر المصحف:</label>
            <input type="checkbox" id="mushaf">
          </div>
          <div>
            <label>التركيز:</label>
            <select id="focus"></select>
          </div>
        </div>
        <button id="calculate">احسب النقاط</button>
        <button id="showRanking">عرض الترتيب</button>
        <button id="exportExcel">تحميل إكسل</button>
        <div class="result" id="result">– %</div>
      </section>
      <section class="stats" id="statsSection" style="display: none;">
        <h3>الإحصائيات</h3>
        <div id="statsList"></div>
      </section>
      <section class="ranking-section" id="rankingSection" style="display: none;">
        <h3>ترتيب الطلاب</h3>
        <table>
          <thead>
            <tr>
              <th>المركز</th>
              <th>الاسم</th>
              <th>النسبة (%)</th>
            </tr>
          </thead>
          <tbody id="rankingBody"></tbody>
        </table>
      </section>
    </main>
  </div>
</body>
</html>
